; Final Test - Target the exact remaining pattern
(include "advanced_partitioning.egg")

; Add the specific pattern we need: nested (a*x + b*y) + x case
(rewrite (Add (Add (Mul (Num ?a) (Var ?v)) (Mul (Num ?b) (Var ?w))) (Var ?v))
         (Add (Mul (Num (+ ?a 1.0)) (Var ?v)) (Mul (Num ?b) (Var ?w))))

; Test just the remaining problematic part: (2*x + 3*y) + x
(let remaining_part (Add (Add (Mul (Num 2.0) (Var "x")) (Mul (Num 3.0) (Var "y"))) (Var "x")))

(run-schedule (repeat 15 (saturate (run))))
(query-extract remaining_part)

; Also test the full complex expression again
(let complex_expr (Add (Add (Add (Add (Num 3.0) (Mul (Num 2.0) (Var "x"))) 
                                (Mul (Num 3.0) (Var "y"))) 
                           (Num 4.0)) 
                      (Var "x")))

(run-schedule (repeat 15 (saturate (run))))
(query-extract complex_expr) 