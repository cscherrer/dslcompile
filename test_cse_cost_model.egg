; Test CSE Cost Model
(datatype Math
  (Num f64)
  (UserVar i64)
  (BoundVar i64)
  (Add Math Math)
  (Mul Math Math)
  (Div Math Math)
  (Let i64 Math Math))

; Simplified test without cost model for now

; CSE rules
(ruleset cse_rules)

; Rule: x * x â†’ let t = x in t * t
(rule ((= lhs (Mul ?expr ?expr)))
      ((union lhs (Let 1000 ?expr (Mul (BoundVar 1000) (BoundVar 1000)))))
      :ruleset cse_rules)

; Test case: (x / y) * (x / y)
(let x (UserVar 0))
(let y (UserVar 1))
(let div_expr (Div x y))
(let test_expr (Mul div_expr div_expr))

; Show original cost
(query-extract test_expr)

; Apply CSE
(run-schedule (saturate cse_rules))

; Show optimized result and cost
(query-extract test_expr) 